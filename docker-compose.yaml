version: 3.9
name: '${DOCKER_NAME:-huly}'
services:
  caddy:
    image: caddy:2.10.2-alpine
    ports:
      - 8080:8080
    volumes:
      - ./caddy:/etc/caddy
      - caddy_data:/data
      - caddy_config:/config
    restart: unless-stopped
  cockroach:
    image: 'cockroachdb/cockroach:latest-v24.2'
    command: 'start-single-node --accept-sql-without-tls'
    environment:
      - 'COCKROACH_DATABASE=${CR_DATABASE}'
      - 'COCKROACH_USER=${CR_USERNAME}'
      - 'COCKROACH_PASSWORD=${CR_USER_PASSWORD}'
    volumes:
      - '${VOLUME_CR_DATA_PATH:-cr_data}:/cockroach/cockroach-data'
      - '${VOLUME_CR_CERTS_PATH:-cr_certs}:/cockroach/certs'
    restart: unless-stopped
  redpanda:
    image: 'docker.redpanda.com/redpandadata/redpanda:v24.3.6'
    command:
      - redpanda
      - start
      - '--kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092'
      - '--advertise-kafka-addr internal://redpanda:9092,external://localhost:19092'
      - '--pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082'
      - '--advertise-pandaproxy-addr internal://redpanda:8082,external://localhost:18082'
      - '--schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081'
      - '--rpc-addr redpanda:33145'
      - '--advertise-rpc-addr redpanda:33145'
      - '--mode dev-container'
      - '--smp 1'
      - '--default-log-level=info'
    environment:
      - 'REDPANDA_SUPERUSER_USERNAME=${REDPANDA_ADMIN_USER:-admin}'
      - 'REDPANDA_SUPERUSER_PASSWORD=${REDPANDA_ADMIN_PWD:-admin_pass}'
    volumes:
      - '${VOLUME_REDPANDA_PATH:-redpanda}:/var/lib/redpanda/data'
    healthcheck:
      test:
        - CMD
        - bash
        - '-lc'
        - 'rpk cluster info -X user=${REDPANDA_ADMIN_USER:-admin} -X pass=${REDPANDA_ADMIN_PWD:-admin_pass} >/dev/null 2>&1'
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped
  minio:
    image: minio/minio
    command: 'server /data --address ":9000" --console-address ":9001"'
    environment:
      - 'MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}'
      - 'MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}'
    volumes:
      - '${VOLUME_FILES_PATH:-files}:/data'
    healthcheck:
      test:
        - CMD
        - bash
        - '-lc'
        - 'curl -fsS http://localhost:9000/minio/health/ready >/dev/null'
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped
  elastic:
    image: 'elasticsearch:7.14.2'
    command: "/bin/sh -c \"./bin/elasticsearch-plugin list | grep -q ingest-attachment || yes | ./bin/elasticsearch-plugin install --silent ingest-attachment; /usr/local/bin/docker-entrypoint.sh eswrapper\"\n"
    environment:
      - discovery.type=single-node
      - 'ES_JAVA_OPTS=-Xms1024m -Xmx1024m'
    volumes:
      - '${VOLUME_ELASTIC_PATH:-elastic}:/usr/share/elasticsearch/data'
    healthcheck:
      test:
        - CMD-SHELL
        - 'wget -qO- http://localhost:9200/_cluster/health | grep -vq "status":"red"'
      interval: 20s
      timeout: 5s
      retries: 10
    restart: unless-stopped
  rekoni:
    image: 'hardcoreeng/rekoni-service:${HULY_VERSION:-latest}'
    environment:
      - 'SECRET=${SECRET}'
    deploy:
      resources:
        limits:
          memory: 500M
    restart: unless-stopped
  transactor:
    image: 'hardcoreeng/transactor:${HULY_VERSION:-latest}'
    environment:
      - SERVER_PORT=3333
      - 'SERVER_SECRET=${SECRET}'
      - 'DB_URL=${CR_DB_URL}'
      - 'STORAGE_CONFIG=minio|minio?accessKey=${MINIO_ROOT_USER}&secretKey=MINIO_ROOT_PASSWORD}'
      - 'FRONT_URL=http://localhost:8087'
      - 'ACCOUNTS_URL=http://account:3000'
      - 'FULLTEXT_URL=http://fulltext:4700'
      - 'STATS_URL=http://stats:4900'
      - 'LAST_NAME_FIRST=${LAST_NAME_FIRST:-true}'
      - 'QUEUE_CONFIG=redpanda:9092'
    restart: unless-stopped
  collaborator:
    image: 'hardcoreeng/collaborator:${HULY_VERSION:-latest}'
    environment:
      - COLLABORATOR_PORT=3078
      - 'SECRET=${SECRET}'
      - 'ACCOUNTS_URL=http://account:3000'
      - 'STATS_URL=http://stats:4900'
      - 'STORAGE_CONFIG=minio|minio?accessKey=${MINIO_ROOT_USER}&secretKey=${MINIO_ROOT_PASSWORD}'
    restart: unless-stopped
  account:
    image: 'hardcoreeng/account:${HULY_VERSION:-latest}'
    environment:
      - SERVER_PORT=3000
      - 'SERVER_SECRET=${SECRET}'
      - 'DB_URL=${CR_DB_URL}'
      - 'TRANSACTOR_URL=ws${SECURE:+s}://${HOST_ADDRESS}/_transactor'
      - 'STORAGE_CONFIG=minio|minio?accessKey=${MINIO_ROOT_USER}&secretKey=${MINIO_ROOT_PASSWORD}'
      - 'FRONT_URL=http://front:8080'
      - 'STATS_URL=http://stats:4900'
      - 'MODEL_ENABLED=*'
      - 'ACCOUNTS_URL=http://account:3000'
      - ACCOUNT_PORT=3000
      - 'QUEUE_CONFIG=redpanda:9092'
    restart: unless-stopped
  workspace:
    image: 'hardcoreeng/workspace:${HULY_VERSION:-latest}'
    environment:
      - 'SERVER_SECRET=${SECRET}'
      - 'DB_URL=${CR_DB_URL}'
      - 'TRANSACTOR_URL=ws${SECURE:+s}://${HOST_ADDRESS}/_transactor'
      - 'STORAGE_CONFIG=minio|minio?accessKey=${MINIO_ROOT_USER}&secretKey=${MINIO_ROOT_PASSWORD}'
      - 'MODEL_ENABLED=*'
      - 'ACCOUNTS_URL=http://account:3000'
      - 'STATS_URL=http://stats:4900'
      - 'QUEUE_CONFIG=redpanda:9092'
    restart: unless-stopped
  front:
    image: 'hardcoreeng/front:${HULY_VERSION:-latest}'
    environment:
      - SERVER_PORT=8080
      - 'SERVER_SECRET=${SECRET}'
      - 'LOVE_ENDPOINT=http${SECURE:+s}://${HOST_ADDRESS}/_love'
      - 'ACCOUNTS_URL=http${SECURE:+s}://${HOST_ADDRESS}/_accounts'
      - 'ACCOUNTS_URL_INTERNAL=http://account:3000'
      - 'REKONI_URL=http${SECURE:+s}://${HOST_ADDRESS}/_rekoni'
      - 'CALENDAR_URL=http${SECURE:+s}://${HOST_ADDRESS}/_calendar'
      - 'GMAIL_URL=http${SECURE:+s}://${HOST_ADDRESS}/_gmail'
      - 'TELEGRAM_URL=http${SECURE:+s}://${HOST_ADDRESS}/_telegram'
      - 'STATS_URL=http${SECURE:+s}://${HOST_ADDRESS}/_stats'
      - UPLOAD_URL=/files
      - 'ELASTIC_URL=http://elastic:9200'
      - 'COLLABORATOR_URL=ws${SECURE:+s}://${HOST_ADDRESS}/_collaborator'
      - 'STORAGE_CONFIG=minio|minio?accessKey=${MINIO_ROOT_USER}&secretKey=${MINIO_ROOT_PASSWORD}'
      - 'TITLE=${TITLE:-Huly Self Host}'
      - 'DEFAULT_LANGUAGE=${DEFAULT_LANGUAGE:-en}'
      - 'LAST_NAME_FIRST=${LAST_NAME_FIRST:-true}'
      - 'DESKTOP_UPDATES_CHANNEL=${HULY_VERSION}'
    restart: unless-stopped
  fulltext:
    image: 'hardcoreeng/fulltext:${HULY_VERSION:-latest}'
    environment:
      - 'SERVER_SECRET=${SECRET}'
      - 'DB_URL=${CR_DB_URL}'
      - 'FULLTEXT_DB_URL=http://elastic:9200'
      - ELASTIC_INDEX_NAME=huly_storage_index
      - 'STORAGE_CONFIG=minio|minio?accessKey=${MINIO_ROOT_USER}&secretKey=${MINIO_ROOT_PASSWORD}'
      - 'REKONI_URL=http://rekoni:4004'
      - 'ACCOUNTS_URL=http://account:3000'
      - 'STATS_URL=http://stats:4900'
      - 'QUEUE_CONFIG=redpanda:9092'
    restart: unless-stopped
  stats:
    image: 'hardcoreeng/stats:${HULY_VERSION:-latest}'
    environment:
      - PORT=4900
      - 'SERVER_SECRET=${SECRET}'
    restart: unless-stopped
volumes:
  elastic: 
  files: 
  cr_data: 
  cr_certs: 
  redpanda: 
